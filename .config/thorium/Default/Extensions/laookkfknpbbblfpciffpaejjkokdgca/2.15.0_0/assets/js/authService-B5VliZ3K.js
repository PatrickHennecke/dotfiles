import{E as e,a as t,u as a,A as s,d as r}from"./promisifiedChrome-CheD9WtZ.js";import{e as o}from"./ResizeSensor-CXS_pGRc.js";import{i,f as n,h as u,g as c}from"./dashboard-CF_jRhAY.js";import{p as l}from"./reactiveCustomization-CrL2eTrh.js";import{u as d}from"./SubscriptionSummary-Bb_CwKvU.js";function g(t){if(!t)throw new e(o.PASSWORD_EMPTY);if(!i(t))throw new e(o.PASSWORD_INVALID)}const w=new class{async generateOneTimePassword(){const{data:e}=await t.post("login/onetime",{medium:"account"});return e.email||(e.uuid=a.getUserUuid()??""),e}async onSuccessfulUserLogin(){localStorage.setItem("loggedIn",String(Date.now())),localStorage.removeItem("onetimeSent"),localStorage.removeItem("doLoginOnNextLoad"),await new Promise((e=>{m.trigger("user:successfulLogin",(async()=>{var t;await s.identify(),await d().refresh(),await a.loadOnboarding(),m.widgetManager.populateWidgets(),m.models.themeManager.initializeThemes(),m.cmd("user.cleanup",{type:"notifications"}),m.cmd("settings.rerender"),m.conditionalFeatures.featureEnabled("team")&&(null==(t=document.getElementsByTagName("body")[0])||t.classList.add("has-team")),e()}))}))}async onSuccessfulAuthResponse(e,t){const s=a.getUserUuid()!==e.user_uuid,r=!!(null==t?void 0:t.keepPreviousUserData);s&&!r&&(a.clearLocalStorage(),await a.clearIndexedDb(),m.trigger("focusMode:stop"),m.models.customization.clear()),await u(e),e.email&&localStorage.setItem("email",e.email),(null==t?void 0:t.migrateLegacy)&&await c.migrateAll()}async login(a,s){try{g(s);const{data:e}=await t.post("user/authenticate",{username:a,password:s});await this.onSuccessfulAuthResponse({...e,email:a},{keepPreviousUserData:!1,migrateLegacy:!1})}catch(i){if(i instanceof e)throw i;throw r(i,{401:o.PASSWORD_INCORRECT})}}async register(s,o,i,n){try{g(i);const{data:{token:e,token_uuid:r,settings:{features:u,user_id:c}}}=await t.post("user/register",{name:s,email:o,password:i,newsletterOptIn:n.newsletterOptIn});await this.onSuccessfulAuthResponse({token:e,token_uuid:r,user_uuid:c,features:u,email:o},{keepPreviousUserData:a.userIsLegacyUnregistered(),migrateLegacy:a.userIsLegacyUnregistered()})}catch(u){if(u instanceof e)throw u;throw r(u)}}async stayUnregistered(e){try{if(localStorage.getItem("unregistered"))return;const{data:{token:a,token_uuid:s,settings:{features:r,user_id:o}}}=await t.post("user/register?canceled=true",{name:e});await this.onSuccessfulAuthResponse({token:a,token_uuid:s,user_uuid:o,features:r},{keepPreviousUserData:!0,migrateLegacy:!1}),l.displayname=e,localStorage.setItem("unregistered","true")}catch(a){throw console.log(a),r(a)}}async checkEmail(a){try{!function(t){if(!t)throw new e(o.EMAIL_EMPTY);if(!n(t))throw new e(o.EMAIL_INVALID.replace("{email}",t))}(a);const{data:s}=await t.post("/user:preregister",{email:a});return s}catch(s){if(s instanceof e)throw s;throw r(s)}}async resetPassword(a,s,o){try{g(o),await t.post("user/forgot",{name:a,email:s,password:o})}catch(i){if(i instanceof e)throw i;throw r(i)}}};export{w as a};