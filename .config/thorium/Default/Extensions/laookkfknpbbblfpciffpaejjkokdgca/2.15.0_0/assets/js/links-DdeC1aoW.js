import{d as t,P as e,V as i}from"./ResizeSensor-CXS_pGRc.js";import{L as s,a,i as r,b as n,c as d,d as o,e as l,f as h}from"./LinksService-BV1Om5gI.js";import{f as c}from"./promisifiedChrome-CheD9WtZ.js";import{M as m}from"./timestampDb-sTUCijT1.js";import{M as u}from"./compareObjects-BF7sSNEf.js";class I{constructor({id:t,url:e,title:i,pinned:s=!1,readOnly:r=!1}={}){if(!t||void 0===i||!e)throw new Error("Legacy link created with incomplete data");this.id=t,this.links=[new a({url:e})],this.title=i,this.pinned=!!s,this.readOnly=r}get hasManyLinks(){return this.links.length>1}}const p=(a=(()=>({linksService:new s(new c("links",{mode:m.Timestamp}))}))().linksService)=>t("links",{plugins:[e.MockData],state:()=>({data:{},loading:!1,loaded:!1,activeItemId:"",activeItem:null}),getters:{service:()=>a,getItems(){return({pinned:t=!1,team:e=!1}={})=>{var i;const s=e?this.getTeamRoot:this.getRoot;if(!s)return[];const a=[];return null==(i=s.linksOrderIds)||i.forEach((e=>{const i=this.getItemById(e);if(i&&(r(i)||n(i))&&(e=>"pinned"in e?e.pinned===t:!t)(i)){let t;r(i)?t=this.buildLinkGroup(i):n(i)&&(t=new I(i)),t&&t.links.length&&a.push(t)}})),a}},getUnPinnedItems(){return this.getItems()},getPinnedItems(){return this.getItems({pinned:!0})},getUnPinnedTeamItems(){return this.getItems({team:!0})},getPinnedTeamItems(){return this.getItems({pinned:!0,team:!0})},getRoot:t=>Object.values(t.data).find(d)||null,getTeamRoot:t=>Object.values(t.data).find(o)||null,getItemById:t=>e=>{const i=t.data[e];return i||null},buildLinkGroup(){return t=>{var e;const i=[];null==(e=t.linksOrderIds)||e.forEach((t=>{const e=this.getItemById(t);e&&l(e)&&i.push(e)}));const s={...t,links:i};return new h(s)}},adding(){return!(!this.activeItem||this.activeItemId)}},actions:{addItem(){this.activeItem=new h},editItem(t){this.activeItemId=t;const e=this.getItemById(t);e&&r(e)&&(this.activeItem=this.buildLinkGroup(e))},clearActiveItem(){this.activeItem=null,this.activeItemId=""},refresh(){this.loading||this.loaded||(this.loading=!0,a.get({success:t=>{Object.keys(this.data).forEach((e=>{e in t||delete this.data[e]})),t.forEach((t=>i.set(this.data,t.id,t))),this.loaded=!0,this.loading=!1}}))},async updatePartialRootLinksOrderIds(t){const e=this.getRoot;e&&await this.update(e.id,{linksOrderIds:[...new Set([...t,...e.linksOrderIds])]})},async deleteLinkGroup(t){const e=this.getItemById(t);if(!e||!r(e)&&!n(e))throw new Error(`Can't find LinkGroup with id ${t}`);await Promise.allSettled(Object.values(this.data).filter((i=>l(i)&&i.parentLinkId===t||i===e)).map((t=>this.delete(t.id))))},async processMutations(t){t.filter((t=>t.method!==u.Delete&&"linksOrderIds"in t.data)).forEach((e=>{if(e.method===u.Create&&r(e.data)){const i=e.data.linksOrderIds;t.push({method:u.Update,id:e.id,data:{linksOrderIds:i}}),Object.assign(e.data,{linksOrderIds:[]});const s=this.getRoot;if(!s)throw new Error("Can't find RootLink");t.push({method:u.Update,id:s.id,data:{linksOrderIds:[...s.linksOrderIds,e.id]}})}else e.method===u.Update&&(t=t.filter((t=>t!==e))).push(e)}));for(const e of t)switch(e.method){case u.Update:await this.update(e.id,e.data);break;case u.Create:if(d(e.data))throw new Error("Can't create root links");if(o(e.data))throw new Error("Can't create root links");if(n(e.data))throw new Error("Can't create legacy links");await this.create(e.data);break;case u.Delete:{const t=this.getItemById(e.id);if(!t)return;if(d(t))throw new Error("Can't delete root links");if(o(t))throw new Error("Can't delete team root links");await this.delete(e.id);break}}},async create(t){return i.set(this.data,t.id,t),await a.create(t),t},async update(t,e){const s=this.getItemById(t);if(!s)throw new Error(`No data found for ${t}`);const r={...s,...e};return i.set(this.data,t,r),await a.update(t,e),r},async delete(t){return i.delete(this.data,t),a.delete(t)}}}),k=p(),f=Object.freeze(Object.defineProperty({__proto__:null,default:k,makeLinksStore:p,useLinksStore:k},Symbol.toStringTag,{value:"Module"}));export{I as L,f as l,k as u};