import{S as e}from"./SoftFocus-BUhesXB-.js";import{e as t}from"./ResizeSensor-CXS_pGRc.js";import{A as s,n as a}from"./promisifiedChrome-CheD9WtZ.js";import{f as r,h as i}from"./dashboard-CF_jRhAY.js";import"./environmentVariables-Cy83xda0.js";import"./timestampDb-sTUCijT1.js";import"./Logger-Dqn8sDPg.js";import"./preload-helper-D7CfCCEq.js";import"./string-KTo4Qfpe.js";import"./main--IJuvtTE.js";import"./localStorage-B4mFdj8F.js";import"./migrateLegacyUserMessageHandler-CU6TUnqH.js";const o=a({name:"Email",externalUpgradeUrl:m.globals.urlRootAccount+"upgrade",directives:{SoftFocus:e},props:{processing:{type:Boolean,default:!1}},data:()=>({email:localStorage.getItem("email")||"",password:"",accountExists:null,showPasswordInput:!1,disablePasswordInput:!1,error:null}),computed:{disableEmailInput(){return this.isLoggedIn()||this.processing},title(){return this.showPasswordInput?(this.accountExists?"Enter your":"Choose a")+" password":(this.isLoggedIn()?"Confirm":"Enter")+" your email"}},created(){this.$e.$on("modal:interceptSubStepCompletion",this.validateForm)},mounted(){this.isLoggedIn()||this.$refs.email.focus()},destroyed(){this.$e.$off("modal:interceptSubStepCompletion",this.validateForm)},methods:{validateForm(){this.processing||(this.error=null,this.email?r(this.email)?!this.isLoggedIn()&&m.utils.useAppleAppPayment()?!this.showPasswordInput||this.disablePasswordInput?this.checkEmail():this.password?this.password.length<6?this.setError(t.PASSWORD_INVALID,"password"):(this.$emit("update:processing",!0),this[this.accountExists?"login":"register"](this.email,this.password).then((e=>{i(e),localStorage.setItem("openAppleUpgradeOnLoad",!0),location.reload()})).catch((e=>{"string"==typeof e&&(e+=' <a target="_blank" href="https://momentumdash.com/contact">Contact us</a> if you need help.'),this.setError(e)})).finally((()=>this.$emit("update:processing",!1)))):this.setError(t.PASSWORD_EMPTY,"password"):(this.saveEmail(),this.$e.$emit("modal:subStepCompletionIntercepted")):this.setError(t.EMAIL_INVALID_SHORT,"email"):this.setError(t.EMAIL_EMPTY,"email"))},register(e,s){const a=m.models.customization.get("displayname");return this.$xhr(m.globals.urlRootLogin+"user/register",{method:"post",data:{name:a,email:e,password:s,version:m.globals.version}}).then((e=>e.data)).catch((e=>{throw console.error(e),t.SERVER_ERROR_GENERAL}))},login(e,s){return this.$xhr(m.globals.urlRootLogin+"user/authenticate",{method:"post",data:{username:e,password:s}}).then((e=>{const t=e.data;let s=t.features&&JSON.parse(atob(t.features));if(s.includes("plus")||s.includes("team"))throw"This account already has an active subscription.";return e.data})).catch((e=>{if("string"==typeof e)throw e;if(400===e.response.status||401===e.status)throw t.PASSWORD_INCORRECT_SHORT;throw 429===e.response.status?t.TOO_MANY_ATTEMPTS:(console.error(e),t.SERVER_ERROR_GENERAL)}))},checkEmail(){return this.$emit("update:processing",!0),this.$xhr.get("user-search?email="+encodeURIComponent(this.email)).then((()=>this.accountExists=!0)).catch((()=>this.accountExists=!1)).finally((()=>{this.showPasswordInput=!0,this.disablePasswordInput=!1,this.$emit("update:processing",!1),this.$nextTick((()=>{var e;return null==(e=this.$refs.password)?void 0:e.focus()}))}))},onEmailFocus(){m.utils.useAppleAppPayment()&&(this.disablePasswordInput=!0)},onEmailBlur(){this.isLoggedIn()||!m.utils.useAppleAppPayment()||!this.disablePasswordInput&&this.showPasswordInput||this.validateForm()},setError(e,t="general"){this.error={message:e,field:t}},saveEmail(){let e=localStorage.getObject("upgrade-data")||{};e.email=this.email,localStorage.setObject("upgrade-data",e)},onEnter(){this.$emit("nextStep")},captureAccountSwitchClickEvent(){s.capture("account switch click",{feature:"upgrade"})},isLoggedIn:()=>m.isLoggedIn()}},(function(){var e=this,t=e._self._c;return t("section",{staticClass:"upgrade-flow choose-email",attrs:{"data-test":"email"}},[t("header",[t("transition",{attrs:{name:"fade",mode:"out-in"}},[t("h2",{key:e.title},[e._v(e._s(e.title))])]),t("div",{staticClass:"description"},[e._v("Upgrade to Plus")])],1),t("div",{staticClass:"form-body"},[t("div",{staticClass:"input-row email-row",class:{error:e.error&&"email"===e.error.field}},[t("div",{staticClass:"label-wrapper"},[t("label",[e._v("Email")]),e.isLoggedIn()?t("a",{staticClass:"external-upgrade",attrs:{"data-test":"change-email",href:e.$options.externalUpgradeUrl},on:{click:e.captureAccountSwitchClickEvent}},[e._v("Change")]):e._e()]),t("input",{directives:[{name:"model",rawName:"v-model.trim",value:e.email,expression:"email",modifiers:{trim:!0}}],ref:"email",staticClass:"input form-field input",class:{disabled:e.disableEmailInput},attrs:{disabled:e.disableEmailInput,"data-test":"email-input",name:"email",type:"email",required:""},domProps:{value:e.email},on:{focus:e.onEmailFocus,blur:[e.onEmailBlur,function(t){return e.$forceUpdate()}],keyup:function(t){return!t.type.indexOf("key")&&e._k(t.keyCode,"enter",13,t.key,"Enter")?null:e.onEnter.apply(null,arguments)},input:function(t){t.target.composing||(e.email=t.target.value.trim())}}})]),t("transition",{attrs:{name:"fade"}},[e.showPasswordInput?t("div",{staticClass:"input-row password-row",class:{error:e.error&&"password"===e.error.field}},[t("label",[e._v("Password")]),t("input",{directives:[{name:"model",rawName:"v-model",value:e.password,expression:"password"},{name:"soft-focus",rawName:"v-soft-focus"}],ref:"password",staticClass:"input form-field password",class:{disabled:e.disablePasswordInput},attrs:{disabled:e.disablePasswordInput||e.processing,name:"password",type:"password"},domProps:{value:e.password},on:{keyup:function(t){return!t.type.indexOf("key")&&e._k(t.keyCode,"enter",13,t.key,"Enter")?null:e.onEnter.apply(null,arguments)},input:function(t){t.target.composing||(e.password=t.target.value)}}})]):e._e()]),t("footer",[e.error?t("div",{staticClass:"form-message error",attrs:{"data-test":"form-error"},domProps:{innerHTML:e._s(e.error.message)}}):e._e()])],1)])}),[],!1,null,"f57473fd").exports;export{o as default};