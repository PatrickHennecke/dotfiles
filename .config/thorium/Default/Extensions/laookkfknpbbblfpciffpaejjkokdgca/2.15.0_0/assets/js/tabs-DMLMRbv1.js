import{d as t,V as e}from"./ResizeSensor-CXS_pGRc.js";import{u as s,w as i,p as a,B as o,f as n}from"./promisifiedChrome-CheD9WtZ.js";class r{constructor({key:t,title:e,url:s,pinned:i,index:a}){this.type=w.Tab,this.key=t,this.title=e,this.url=s,this.pinned=i,this.index=a}}class d{constructor({key:t,tabs:e,index:s,color:i="grey",title:a="",collapsed:o=!1,manifestVersion:n}){this.type=w.Group,this.key=t,this.index=s,this.tabs=e.map((t=>new r(t))).sort(((t,e)=>t.index-e.index)),this.color=i,this.title=a,this.collapsed=o,this.manifestVersion=n||2}}var w=(t=>(t.Tab="Tab",t.Group="Group",t))(w||{});const l=["app","devtools"];class c{constructor({key:t,activeTabKey:e,state:s,type:i,left:a,top:o,width:n,height:w,browserSessionKey:l,tabsAndGroups:c}){this.tabsAndGroups=[],this.key=t,this.activeTabKey=e,this.state=s,this.type=i,this.left=a,this.top=o,this.width=n,this.height=w,l&&(this.browserSessionKey=l),this.tabsAndGroups=c.map((t=>"tabs"in t?new d(t):new r(t))).sort(((t,e)=>t.index-e.index))}get tabCount(){let t=0;return this.tabsAndGroups.forEach((e=>{t+=e instanceof r?1:e.tabs.length})),t}}const u=t=>{if(void 0!==t.id&&void 0!==t.state&&void 0!==t.type&&"app"!==t.type&&"devtools"!==t.type)return{key:t.id,state:t.state,type:t.type,left:t.left||0,top:t.top||0,width:t.width||window.outerWidth,height:t.height||window.outerHeight}};class h{constructor({id:t,name:e,windows:s,activeWindowKey:i,browser:a,dateCreated:o}){this.windows=[],this.id=t,this.name=e,this.windows=s.map((t=>new c(t))),this.activeWindowKey=i,this.browser=a,this.dateCreated=o}get totalTabCount(){return this.windows.map((t=>t.tabCount)).reduce(((t,e)=>t+e))}get displayName(){return this.name||s.getFriendlyDateTime(new Date(this.dateCreated))}get sessionDescriptionTabs(){const t=this.totalTabCount;return`${t} tab${t>1?"s":""}`}get sessionDescriptionWindows(){return`${this.windows.length} window${this.windows.length>1?"s":""}`}}var p=(t=>(t.List="list",t.Detail="detail",t))(p||{});const b=["tabs","sessions"],f=["tabs","sessions","tabGroups"],y={ERROR_STASH:"Oops, we couldn't save that session at this time.",ERROR_RESTORE:"Oops, we couldn't restore that session at this time.",ERROR_NO_OTHER_TABS:"No tabs to stash.",ERROR_DELETE:"Oops, there was a problem deleting that session.",ERROR_ALL_DELETE:"Oops, there was a problem deleting all sessions.",SUCCESSFUL_STASH_PARTIAL:" saved to a new session.",SUCCESSFUL_RESTORE_PARTIAL:" session restored.",SUCCESSFUL_ALL_DELETE:"All session deleted.",DELETE_PARTIAL:" session deleted."},g="chrome://newtab/",v="https://get.momentumdash.help/hc/en-us/articles/14474141114391";class S{constructor(t){this.dataService=t}get(t){this.dataService.get(t)}create(t){return this.dataService.create(t.id,t)}update(t,e,s={}){return this.dataService.update(t,e,s)}delete(t){return this.dataService.delete(t)}async ensurePermissions(){const t=i()?b:f;return!!(await a.permissions.contains({permissions:t}))||new Promise((e=>{m.cmd("modal.open","PERMISSION_REQUEST",{widgetName:"Tab Stash",permissionExplanation:"To save your tabs for later",permissions:{permissions:t},resolve:e})}))}async closeWindowsAndSetSessionIds(t){var e;for(const i of t.windows)try{if(1===i.tabsAndGroups.length&&(null==(e=i.tabsAndGroups[0])?void 0:e.type)===w.Tab&&i.tabsAndGroups[0].url===g)await a.windows.remove(i.key);else{await a.windows.removeAndWaitForSessionChange(i.key);const t=await a.sessions.getLastClosedSessionId();t&&(i.browserSessionKey=t)}}catch(s){console.warn(s)}return t}async restoreSession(t){const e=t.windows.filter((e=>e.key!==t.activeWindowKey)),s=t.windows.filter((e=>e.key===t.activeWindowKey)),i=await a.tabs.query({currentWindow:!0}),o=i.find((t=>t.active));if(!o||!o.id)throw new Error("Could not find active tab id from current window");let n=o.windowId;for(const r of[...e,...s]){const e=await this.restoreWindow(r,t.browser);r.key===t.activeWindowKey&&1===i.length&&e.id&&(o.pinned&&await a.tabs.update(o.id,{pinned:!1}),await a.tabs.moveToWindow(o.id,e.id),n=e.id,o.pinned&&await a.tabs.update(o.id,{pinned:!0}))}await this.focusTabAndWindow(o.id,n)}async getSessionFromWindows(){var t;const e=await a.tabs.query({currentWindow:!0}),i=await a.tabs.getCurrent();let n=-1;i&&1!==e.length&&i.id&&(await this.pullTabInNewWindow(i),n=i.windowId);const r={id:s.uuidv4(),name:"",windows:[],activeWindowKey:n,browser:o(),dateCreated:(new Date).toISOString()},d=await a.windows.getAll(),w=null==(t=await a.windows.getCurrent())?void 0:t.id;for(const s of d){if(w===s.id||s.type&&l.includes(s.type))continue;const t=u(s);if(!t)throw new Error(`window returned by browser (${r.browser}) does not satisfy IWindow type`);const e=await this.setTabsDataForWindow(t,r.browser);r.windows.push(e)}return new h(r)}async openPartialSession(t){t instanceof c?await this.fallbackRestoreWindow(t,o()):t instanceof d?await this.createGroup(t):t instanceof r&&await a.tabs.create({url:t.url,pinned:t.pinned})}async createGroup(t){const e=[];for(const s of t.tabs){const t=await a.tabs.create({url:s.url,pinned:s.pinned});t.id&&e.push(t.id)}if(void 0!==chrome.tabs.group){const s=await a.tabs.group({tabIds:e});if(chrome.tabGroups&&3===t.manifestVersion){const{color:e,collapsed:i,title:a}=t;await chrome.tabGroups.update(s,{color:e,collapsed:i,title:a})}}}async pullTabInNewWindow(t){const e=t.id;if(!e)throw new Error("Could not read tab id when pulling out tab from window");const s=await a.windows.get(t.windowId),i={left:s.left,top:s.top,width:s.width,height:s.height};let o;if("normal"===s.state&&(o=await a.windows.create({tabId:e,...i})),o||(o=await a.windows.create({tabId:e})),!o)throw new Error("Could not create window when pulling out tab from window");t.pinned&&await a.tabs.update(e,{pinned:!0})}async setTabsDataForWindow(t,e){var s;const i=await a.tabs.query({windowId:t.key}),o=i.map((t=>{const s=(t=>{if(void 0!==t.id&&void 0!==t.url)return{key:t.id,title:t.title||"",url:t.url,pinned:t.pinned,index:t.index,type:w.Tab}})(t);if(!s)throw new Error(`tab returned by browser (${e})could not be converted to ITab`);return s})).sort(((t,e)=>t.index-e.index)),n=[];for(let a=0;a<o.length;a++){const t=o[a],e=i[a];if(t&&e)if(~e.groupId&&void 0!==e.groupId){const t=i.filter((t=>t.groupId===e.groupId)).length;let s={};if(chrome&&chrome.tabGroups){const t=await chrome.tabGroups.get(e.groupId),{color:i,collapsed:a,title:o=""}=t;s={color:i,collapsed:a,title:o,manifestVersion:3}}const r={key:e.groupId,index:a,type:w.Group,tabs:o.slice(a,a+t),...s};a+=t-1,n.push(r)}else n.push(t)}return{...t,activeTabKey:(null==(s=i.find((t=>t.active)))?void 0:s.id)||-1,tabsAndGroups:n}}async restoreWindow(t,e){const s=t.browserSessionKey;let i;return s&&(i=await a.sessions.restoreWindow(s)),i||(i=await this.fallbackRestoreWindow(t,e)),i}async fallbackRestoreWindow(t,e){var s,i,o,n,w;let c;const{tabsAndGroups:u,activeTabKey:h,key:p,browserSessionKey:b,...f}=t,y=u.map((t=>t instanceof r?[t]:t.tabs)).flat(),m={...f};if(m.type&&l.includes(m.type)&&(m.type="normal"),m.url=this.getUrlArrayForWindowCreateFromTabs(y,e),["maximized","minimized","fullscreen"].includes(t.state)){["width","height","left","top"].forEach((t=>delete m[t]))}if(c=await a.windows.create(m),!c){["left","top"].forEach((t=>delete m[t])),c=await a.windows.create(m)}if(!c){["width","height"].forEach((t=>delete m[t])),c=await a.windows.create(m)}if(!c)throw new Error("Could not create window");if(void 0!==chrome.tabs.group)for(const r of u){if(!(r instanceof d))continue;const t=r.index,e=t+r.tabs.length,i={tabIds:((null==(s=c.tabs)?void 0:s.slice(t,e))||[]).flatMap((t=>void 0===t.id?[]:[t.id])),createProperties:{windowId:c.id}},o=await a.tabs.group(i);if(chrome.tabGroups&&3===r.manifestVersion){const{color:t,collapsed:e,title:s}=r;await chrome.tabGroups.update(o,{color:t,collapsed:e,title:s})}}for(let r=0;r<y.length;r++){const t=y[r];if(null==t?void 0:t.pinned){const t=null==(o=null==(i=c.tabs)?void 0:i[r])?void 0:o.id;if(!t)continue;await a.tabs.update(t,{pinned:!0})}}const g=y.find((t=>t.key===h));if(g){const t=y.indexOf(g),e=null==(w=null==(n=c.tabs)?void 0:n[t])?void 0:w.id;e&&await a.tabs.update(e,{active:!0})}return c}getUrlArrayForWindowCreateFromTabs(t,e){const i=t=>t.startsWith(e+"-extension://")||t.startsWith(e+"://"),a=t.map((t=>t.url===g&&s.isFirefox()?"/dashboard.html":i(t.url)?t.url.replace(e,o()):t.url)).filter((t=>!(i(t)&&s.isFirefox()||t.startsWith("about:"))));return 0===a.length&&a.push("/dashboard.html"),a}async focusTabAndWindow(t,e){t&&await a.tabs.update(t,{active:!0}),e&&await a.windows.update(e,{focused:!0})}}const T=()=>({tabStashService:new S(new n("tabs"))}),E=(s=T().tabStashService)=>t("tabs",{state:()=>({data:{},loading:!1,loaded:!1,activeItemId:""}),getters:{getItems:t=>Object.values(t.data).map((t=>new h(t))).sort(((t,e)=>Date.parse(e.dateCreated)-Date.parse(t.dateCreated))),getItemById:t=>e=>{const s=t.data[e];return s?new h(s):null}},actions:{refresh(){this.loading=!0,s.get({success:t=>{t.forEach((t=>e.set(this.data,t.id,t))),this.loaded=!0,this.loading=!1}})},async stashSession(){if(!(await s.ensurePermissions()))return;const t=await s.getSessionFromWindows();return 0===t.windows.length||(await this.create(t),await s.closeWindowsAndSetSessionIds(t),await this.update(t.id,{windows:t.windows})),t},async restoreSession(t){if(await s.ensurePermissions())return await s.restoreSession(t),await this.delete(t.id),!0},async create(t){e.set(this.data,t.id,t),await s.create(t)},async delete(t){e.delete(this.data,t),await s.delete(t)},async update(t,i){const a=this.data[t];if(!a)throw new Error(`No data found for ${t}`);const o={...a,...i};e.set(this.data,t,o);const n=Object.keys(i).join(",");return await s.update(t,o,{queryParams:{update_mask:n}}),o},ensurePermissions:()=>s.ensurePermissions()}}),W=E(),I=Object.freeze(Object.defineProperty({__proto__:null,default:W,makeTabsStore:E,useTabsStore:W},Symbol.toStringTag,{value:"Module"}));export{d as G,v as H,h as S,p as T,c as W,r as a,w as b,y as m,T as p,I as t,W as u};